(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[990],{4384:function(s,e,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/5-eks-datadog",function(){return n(5951)}])},1290:function(s,e,n){"use strict";var a=n(5893),l=n(5711),t=n.n(l),r=function(s){var e=s.src,n=s.alt,l=s.width,r=s.height;return(0,a.jsx)("img",{className:t().carousel,src:e,alt:n,width:l,height:r})};e.Z=r,r.defaultProps={width:"100%",height:"100%"}},5951:function(s,e,n){"use strict";n.r(e);var a=n(5893),l=n(1151),t=n(1290);function r(s){var e=Object.assign({h1:"h1",p:"p",code:"code",ol:"ol",li:"li",a:"a",h2:"h2",pre:"pre",span:"span",strong:"strong",hr:"hr",em:"em"},(0,l.ah)(),s.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.h1,{children:"Sending application logs from EKS to Datadog"}),"\n",(0,a.jsxs)(e.p,{children:["Datadog has been part of our stack for quite sometime now, where the ",(0,a.jsx)(e.code,{children:"datadog-agent"})," installed on the EC2 instances (baked into the image) tail log files to which the application services write to."]}),"\n",(0,a.jsx)(e.p,{children:"A recent project required me to send the application logs deployed on kubernetes to Datadog. This required a different approach which I would be sharing today. A few pre-requisites before I begin:"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:["An up and running kubernetes cluster. I use ",(0,a.jsx)(e.a,{href:"https://eksctl.io/",children:(0,a.jsx)(e.code,{children:"eksctl"})})," to quickly spin up a k8s cluster on AWS EKS."]}),"\n",(0,a.jsxs)(e.li,{children:["A ",(0,a.jsx)(e.a,{href:"https://www.datadoghq.com/",children:"Datadog"})," account"]}),"\n",(0,a.jsx)(e.li,{children:"Helm v3 installed (v3 doesn't require you to setup Tiller (Helm's server component) on your kubernetes cluster)"}),"\n"]}),"\n",(0,a.jsx)(e.h2,{children:"Pre-requisites"}),"\n",(0,a.jsx)(e.p,{children:"To set the context, I have a 3-node cluster set up:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"hljs language-sh",children:"$ kubectl get nodes\nNAME                                        STATUS   ROLES    AGE   VERSION\nip-10-0-0-34.ap-south-1.compute.internal    Ready    <none>   9d    v1.16.13-eks-2ba888\nip-10-0-1-144.ap-south-1.compute.internal   Ready    <none>   9d    v1.16.13-eks-2ba888\nip-10-0-2-79.ap-south-1.compute.internal    Ready    <none>   9d    v1.16.13-eks-2ba888\n"})}),"\n",(0,a.jsx)(e.p,{children:"Add and update the Datadog chart repository,"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:[(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Ensure that you are running helm v3"}),"\n$ helm version --short\nv3.3.1+g249e521\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Add and update the Datadog and stable chart repositories"}),"\n$ helm repo add datadog https://helm.datadoghq.com\n",(0,a.jsx)(e.span,{className:"hljs-string",children:'"datadog"'})," has been added to your repositories\n\n$ helm repo add stable https://kubernetes-charts.storage.googleapis.com/\n",(0,a.jsx)(e.span,{className:"hljs-string",children:'"stable"'})," has been added to your repositories\n\n$ helm repo update\nHang tight ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"while"})," we grab the latest from your chart repositories...\n...Successfully got an update from the ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"stable"'})," chart repository\nUpdate Complete. \u2388Happy Helming!\u2388\n\n$ helm repo list\nNAME   \tURL                                              \nstable \thttps://kubernetes-charts.storage.googleapis.com/\ndatadog\thttps://helm.datadoghq.com        \n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Search for datadog chart. We will be using datadog/datadog"}),"\n$ helm search repo datadog\nNAME           \tCHART VERSION\tAPP VERSION\tDESCRIPTION             \ndatadog/datadog\t2.4.13       \t7          \tDatadog Agent           \nstable/datadog \t2.3.42       \t7          \tDEPRECATED Datadog Agent\n"]})}),"\n",(0,a.jsxs)(e.p,{children:["Clone the git repository ",(0,a.jsx)(e.code,{children:"bensooraj/node-eks-datadog-integration"}),":"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ git ",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"clone"})," https://github.com/bensooraj/node-eks-datadog-integration.git\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# A quick overview overview of the project structure"}),"\n$ tree -L 2\n.\n\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 coverage\n\u251c\u2500\u2500 datadog\n\u2502   \u2514\u2500\u2500 values.yml\n\u251c\u2500\u2500 docker\n\u2502   \u2514\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 kubernetes\n\u2502   \u251c\u2500\u2500 deployment.yaml\n\u2502   \u2514\u2500\u2500 service.yaml\n\u251c\u2500\u2500 node_modules\n\u2502   \u251c\u2500\u2500 @dabh\n\u2502   ....\n\u2502   ...\n\u2502   ..\n\u2502   \u251c\u2500\u2500 winston\n\u2502   \u2514\u2500\u2500 winston-transport\n\u251c\u2500\u2500 package-lock.json\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 server.js\n\n83 directories, 9 files\n"]})}),"\n",(0,a.jsxs)(e.p,{children:["Check ",(0,a.jsx)(e.a,{href:"https://github.com/DataDog/helm-charts/blob/master/charts/datadog/values.yaml",children:"datadog-values.yaml"})," for the latest YAML file."]}),"\n",(0,a.jsx)(e.h2,{children:"Deploy the application"}),"\n",(0,a.jsxs)(e.p,{children:["We will be deploying an ultra simple Node.js API which logs out JSON formatted log messages whenever it receives a ",(0,a.jsx)(e.code,{children:"GET"})," request:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-js",children:[(0,a.jsx)(e.span,{className:"hljs-comment",children:"// server.js"}),"\n",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"const"})," express = ",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"require"}),"(",(0,a.jsx)(e.span,{className:"hljs-string",children:"'express'"}),");\n",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"const"})," winston = ",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"require"}),"(",(0,a.jsx)(e.span,{className:"hljs-string",children:"'winston'"}),");\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"// Constants"}),"\n",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"const"})," ",(0,a.jsx)(e.span,{className:"hljs-variable constant_",children:"PORT"})," = ",(0,a.jsx)(e.span,{className:"hljs-number",children:"8080"}),";\n",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"const"})," ",(0,a.jsx)(e.span,{className:"hljs-variable constant_",children:"HOST"})," = ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'0.0.0.0'"}),";\n\n",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"const"})," app = ",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"express"}),"();\n\n",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"const"})," logger = winston.",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"createLogger"}),"({\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"transports"}),": [\n        ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"new"})," winston.",(0,a.jsx)(e.span,{className:"hljs-property",children:"transports"}),".",(0,a.jsx)(e.span,{className:"hljs-title class_",children:"Console"}),"({\n            ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"handleExceptions"}),": ",(0,a.jsx)(e.span,{className:"hljs-literal",children:"true"}),",\n        })\n    ],\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"level"}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'debug'"}),",\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"exitOnError"}),": ",(0,a.jsx)(e.span,{className:"hljs-literal",children:"false"}),",\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"format"}),": winston.",(0,a.jsx)(e.span,{className:"hljs-property",children:"format"}),".",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"combine"}),"(\n        winston.",(0,a.jsx)(e.span,{className:"hljs-property",children:"format"}),".",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"splat"}),"(),\n        winston.",(0,a.jsx)(e.span,{className:"hljs-property",children:"format"}),".",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"timestamp"}),"(),\n        winston.",(0,a.jsx)(e.span,{className:"hljs-property",children:"format"}),".",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"json"}),"()\n    ),\n});\n\napp.",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"get"}),"(",(0,a.jsx)(e.span,{className:"hljs-string",children:"'/'"}),", ",(0,a.jsxs)(e.span,{className:"hljs-function",children:["(",(0,a.jsx)(e.span,{className:"hljs-params",children:"req, res"}),") =>"]})," {\n    logger.",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"silly"}),"(",(0,a.jsx)(e.span,{className:"hljs-string",children:'"This is a silly message"'}),", { ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"url"}),": req.",(0,a.jsx)(e.span,{className:"hljs-property",children:"url"}),", ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"environment"}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'})," });\n    logger.",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"debug"}),"(",(0,a.jsx)(e.span,{className:"hljs-string",children:'"This is a debug message"'}),", { ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"url"}),": req.",(0,a.jsx)(e.span,{className:"hljs-property",children:"url"}),", ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"environment"}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'})," });\n    logger.",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"info"}),"(",(0,a.jsx)(e.span,{className:"hljs-string",children:'"This is an info message"'}),", { ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"url"}),": req.",(0,a.jsx)(e.span,{className:"hljs-property",children:"url"}),", ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"environment"}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'})," });\n\n    res.",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"json"}),"({\n        ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"response_message"}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'Hello World'"}),"\n    });\n});\n\napp.",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"listen"}),"(",(0,a.jsx)(e.span,{className:"hljs-variable constant_",children:"PORT"}),", ",(0,a.jsx)(e.span,{className:"hljs-variable constant_",children:"HOST"}),");\nlogger.",(0,a.jsx)(e.span,{className:"hljs-title function_",children:"info"}),"(",(0,a.jsx)(e.span,{className:"hljs-string",children:'"Running on http://${HOST}:${PORT}"'}),", { ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"host"}),": ",(0,a.jsx)(e.span,{className:"hljs-variable constant_",children:"HOST"}),", ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"port"}),": ",(0,a.jsx)(e.span,{className:"hljs-variable constant_",children:"PORT"}),", ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"environment"}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'})," });\n"]})}),"\n",(0,a.jsx)(e.p,{children:"Relevant sections from the deployment YAML file,"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-yaml",children:[(0,a.jsx)(e.span,{className:"hljs-attr",children:"apiVersion:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"apps/v1"}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"kind:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"Deployment"}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"metadata:"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"name:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"eks-datadog-demo-node-app"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"annotations:"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"ad.datadoghq.com/eks-datadog-demo-node-app.logs:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'\'[{"source":"nodejs","service":"eks-datadog-demo-node-app"}]\''}),"  \n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"labels:"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"tags.datadoghq.com/env:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"tags.datadoghq.com/service:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"eks-datadog-demo-node-app"'}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"tags.datadoghq.com/version:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"v1.0.1"'}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"spec:"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# # #"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# #"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"#"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"template:"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"metadata:"}),"\n      ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"annotations:"}),"\n        ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"ad.datadoghq.com/eks-datadog-demo-node-app.logs:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'\'[{"source":"nodejs","service":"eks-datadog-demo-node-app"}]\''}),"\n      ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"labels:"}),"\n        ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"app:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"eks-datadog-demo-node-app"}),"\n        ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"tags.datadoghq.com/env:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'}),"\n        ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"tags.datadoghq.com/service:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"eks-datadog-demo-node-app"'}),"\n\t\t",(0,a.jsx)(e.span,{className:"hljs-attr",children:"tags.datadoghq.com/version:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"v1.0.1"'}),"\n\t",(0,a.jsx)(e.span,{className:"hljs-attr",children:"spec:"}),"\n      ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"containers:"}),"\n        ",(0,a.jsx)(e.span,{className:"hljs-bullet",children:"-"})," ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"name:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"eks-datadog-demo-node-app"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# # #"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# #"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"#"}),"\n"]})}),"\n",(0,a.jsxs)(e.p,{children:["Pay close attention to the ",(0,a.jsx)(e.code,{children:"labels"})," and ",(0,a.jsx)(e.code,{children:"annotations"}),". These are especially useful if you are planning to collect ",(0,a.jsx)(e.code,{children:"traces"})," and application ",(0,a.jsx)(e.code,{children:"metrics"}),", which are outside the scope of this article."]}),"\n",(0,a.jsxs)(e.p,{children:["It's worth mentioning that you can exclude or include logs from deployments and/or pods by configuring the settings in the ",(0,a.jsx)(e.a,{href:"https://docs.datadoghq.com/agent/logs/advanced_log_collection/?tab=kubernetes#exclude-at-match",children:(0,a.jsx)(e.code,{children:"annotations"})}),". For example, to exclude all logs from the above deployment configure the ",(0,a.jsx)(e.code,{children:"log_processing_rules"})," in the ",(0,a.jsx)(e.code,{children:"annotations"})," section as follows:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-yaml",children:[(0,a.jsx)(e.span,{className:"hljs-attr",children:"apiVersion:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"apps/v1"}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"kind:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"Deployment"}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"metadata:"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"name:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"eks-datadog-demo-node-app"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"annotations:"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"ad.datadoghq.com/eks-datadog-demo-node-app.logs:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'>-\n      [{\n        "source": "nodejs",\n        "service": "eks-datadog-demo-node-app",\n        "log_processing_rules": [{\n          "type": "exclude_at_match",\n          "name": "exclude_this_deployment",\n          "pattern":"\\.*"\n        }]\n      }]  \n'}),"  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"labels:"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"tags.datadoghq.com/env:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"tags.datadoghq.com/service:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"eks-datadog-demo-node-app"'}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"tags.datadoghq.com/version:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"v1.0.1"'}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"spec:"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# # #"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# #"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"#"}),"\n"]})}),"\n",(0,a.jsx)(e.p,{children:"Deploy the API and exopse it as a service,"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:[(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Deployment"}),"\n$ kubectl apply -f kubernetes/deployment.yaml\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Service"}),"\n$ kubectl apply -f kubernetes/service.yaml\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Verify that the API is up and running"}),"\n$ kubectl get deployment,svc,po\nNAME                                               READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/eks-datadog-demo-node-app          2/2     2            2           30h\n\nNAME                                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nservice/eks-datadog-demo-node-app          ClusterIP   172.20.205.150   <none>        8080/TCP   30h\n\nNAME                                                    READY   STATUS    RESTARTS   AGE\npod/eks-datadog-demo-node-app-7bf7cf764f-gpqvf          1/1     Running   0          29h\npod/eks-datadog-demo-node-app-7bf7cf764f-spb7m          1/1     Running   0          29h\n"]})}),"\n",(0,a.jsx)(e.h2,{children:"Deploy the Datadog agent"}),"\n",(0,a.jsxs)(e.p,{children:["Open the file ",(0,a.jsx)(e.code,{children:"datadog/values.yml"})," and ensure that ",(0,a.jsx)(e.code,{children:"datadog.logs.enabled"})," and ",(0,a.jsx)(e.code,{children:"datadog.logs.containerCollectAll"})," are set to ",(0,a.jsx)(e.code,{children:"true"}),"."]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-yaml",children:[(0,a.jsx)(e.span,{className:"hljs-attr",children:"datadog:"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"## @param logs - object - required"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"## Enable logs agent and provide custom configs"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"#"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"logs:"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"## @param enabled - boolean - optional - default: false"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"## Enables this to activate Datadog Agent log collection."}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"#"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"enabled:"})," ",(0,a.jsx)(e.span,{className:"hljs-literal",children:"true"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"## @param containerCollectAll - boolean - optional - default: false"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"## Enable this to allow log collection for all containers."}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-comment",children:"#"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"containerCollectAll:"})," ",(0,a.jsx)(e.span,{className:"hljs-literal",children:"true"}),"\n"]})}),"\n",(0,a.jsx)(e.p,{children:"Deploy the datadog-agent:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ helm install datadog-agent -f datadog/values.yml  --",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"set"})," datadog.apiKey=<DATADOG_API_KEY> datadog/datadog\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Helm will deploy one datadog-agent pod per node"}),"\n$ kubectl get deployment,svc,po\nNAME                                               READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/datadog-agent-kube-state-metrics   1/1     1            1           29h\n\nNAME                                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nservice/datadog-agent-kube-state-metrics   ClusterIP   172.20.129.97    <none>        8080/TCP   29h\n\nNAME                                                    READY   STATUS    RESTARTS   AGE\npod/datadog-agent-b4mtv                                 2/2     Running   0          29h\npod/datadog-agent-f6jn7                                 2/2     Running   0          29h\npod/datadog-agent-zvp6p                                 2/2     Running   0          29h\n"]})}),"\n",(0,a.jsxs)(e.p,{children:["Note that even though the agent is deployed in the ",(0,a.jsx)(e.code,{children:"default"})," namespace, it can collect logs and metrics from deployments/pods from all namespaces."]}),"\n",(0,a.jsx)(e.h2,{children:"O Logs! Where art thou?"}),"\n",(0,a.jsx)(e.p,{children:"Now we have the API service (for generating logs) and the Datadog agent (for streaming the logs to Datadog) all set! I assume this is what happens behind the scenes:"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:["The API service writes logs to ",(0,a.jsx)(e.strong,{children:(0,a.jsx)(e.code,{children:"stdout"})})," and ",(0,a.jsx)(e.strong,{children:(0,a.jsx)(e.code,{children:"stderr"})})]}),"\n",(0,a.jsxs)(e.li,{children:["The ",(0,a.jsx)(e.strong,{children:(0,a.jsx)(e.code,{children:"kubelet"})})," writes these logs to ",(0,a.jsx)(e.strong,{children:(0,a.jsx)(e.code,{children:"/var/log/pods/<namespace>_<pod_name>_<pod_id>/<container_name>/<num>.log"})})," on the node machine"]}),"\n",(0,a.jsxs)(e.li,{children:["The **",(0,a.jsx)(e.code,{children:"datadog-agent"}),"**s running on each node tails these log files and streams them to the Datadog servers"]}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"Anyways, let's generate some logs:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:[(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Port forward to access the API service from your local machine"}),"\n$ kubectl port-forward service/eks-datadog-demo-node-app 8080:8080\nForwarding from 127.0.0.1:8080 -> 8080\nForwarding from [::1]:8080 -> 8080\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Generate some logs using curl or ab"}),"\n$ ab -n 50 -c 2 -l http://localhost:8080/\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Verify that the logs are generated"}),"\nj$ kubectl logs -l app=eks-datadog-demo-node-app --since=100m\n{",(0,a.jsx)(e.span,{className:"hljs-string",children:'"url"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"/"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"environment"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"level"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"debug"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"message"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"This is a debug message"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"timestamp"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"2020-09-04T19:35:52.126Z"'}),"}\n{",(0,a.jsx)(e.span,{className:"hljs-string",children:'"url"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"/"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"environment"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"level"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"info"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"message"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"This is an info message"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"timestamp"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"2020-09-04T19:35:53.308Z"'}),"}\n....\n...\n{",(0,a.jsx)(e.span,{className:"hljs-string",children:'"url"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"/"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"environment"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"level"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"debug"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"message"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"This is a debug message"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"timestamp"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"2020-09-04T19:35:53.310Z"'}),"}\n{",(0,a.jsx)(e.span,{className:"hljs-string",children:'"url"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"/"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"environment"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"test"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"level"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"info"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"message"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"This is an info message"'}),",",(0,a.jsx)(e.span,{className:"hljs-string",children:'"timestamp"'}),":",(0,a.jsx)(e.span,{className:"hljs-string",children:'"2020-09-04T19:35:53.310Z"'}),"}\n"]})}),"\n",(0,a.jsxs)(e.p,{children:["Navigate to ",(0,a.jsx)(e.code,{children:"Log Explorer"})," in Datadog to see the logs that we generated above"]}),"\n",(0,a.jsx)(t.Z,{src:"/5/2_dd_ui_overview.png",alt:"Datadog UI overview"}),"\n",(0,a.jsx)(e.p,{children:"Click on any one of the log records to view more details"}),"\n",(0,a.jsx)(t.Z,{src:"/5/2_dd_log_detail_view.png",alt:"Datadog log record detail view"}),"\n",(0,a.jsx)(e.p,{children:"On the left pane, you can filter the logs by namespace, pods etc. as well!"}),"\n",(0,a.jsx)(t.Z,{src:"/5/2_filter_ui_ns.png",alt:"Datadog log record detail view UI"}),"\n",(0,a.jsx)(e.p,{children:"That's it for now!"}),"\n",(0,a.jsx)(e.p,{children:"I hope this helped and if you have any feedback for me, please let me know :smile:."}),"\n",(0,a.jsx)(e.p,{children:"Further reading:"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://kubernetes.io/docs/concepts/cluster-administration/logging/",children:"Logging Architecture"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://docs.datadoghq.com/agent/kubernetes/log/?tab=daemonset#log-collection",children:"Datadog kubernetes log collection"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://docs.datadoghq.com/agent/kubernetes/?tab=daemonset",children:"Datadog agent as a DaemonSet (recommended)"})}),"\n"]}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsxs)(e.p,{children:["Note: ",(0,a.jsx)(e.em,{children:"This article is not an in-depth tutorial on implemending logging for applications running on kubernetes, but a journal of my learnings."})]})]})}e.default=function(s){var e=void 0===s?{}:s,n=Object.assign({},(0,l.ah)(),e.components).wrapper;return n?(0,a.jsx)(n,Object.assign({},e,{children:(0,a.jsx)(r,e)})):r(e)}},5711:function(s){s.exports={carousel:"MDImage_carousel__N8hEe"}}},function(s){s.O(0,[774,888,179],(function(){return e=4384,s(s.s=e);var e}));var e=s.O();_N_E=e}]);