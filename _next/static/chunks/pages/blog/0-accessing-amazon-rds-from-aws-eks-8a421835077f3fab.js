(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[10],{9630:function(s,e,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/0-accessing-amazon-rds-from-aws-eks",function(){return n(9803)}])},1290:function(s,e,n){"use strict";var a=n(5893),l=n(5711),c=n.n(l),r=function(s){var e=s.src,n=s.alt,l=s.width,r=s.height;return(0,a.jsx)("img",{className:c().carousel,src:e,alt:n,width:l,height:r})};e.Z=r,r.defaultProps={width:"100%",height:"100%"}},9803:function(s,e,n){"use strict";n.r(e);var a=n(5893),l=n(1151),c=n(1290);function r(s){var e=Object.assign({h1:"h1",h2:"h2",ol:"ol",li:"li",a:"a",p:"p",h3:"h3",code:"code",strong:"strong",pre:"pre",span:"span",em:"em",blockquote:"blockquote"},(0,l.ah)(),s.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.h1,{children:"Accessing Amazon RDS From AWS EKS"}),"\n",(0,a.jsxs)(e.h2,{children:["Contents ",(0,a.jsx)("a",{id:"contents"})]}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#premise",children:"Premise"})}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.a,{href:"#setup-the-mysql-database",children:"Setup the MySQL Database - Amazon RDS"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#rds-create-the-vpc",children:"Create the VPC"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#rds-create-subnets",children:"Create the subnets"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#rds-create-db-subnet-group",children:"Create the DB subnet group"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#rds-create-vpc-security-group",children:"Create the VPC security group"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#rds-create-db-instance-in-the-vpc",children:"Create a DB instance in the VPC"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#rds-setup-diagram",children:"Amazon RDS setup diagram"})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#setup-the-eks-cluster",children:"Setup the EKS cluster"})}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.a,{href:"#lets-build-the-bridge",children:"Let's build the bridge!"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#create-and-accept-vpc-peering-connections",children:"Create and Accept a VPC Peering Connection"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#update-eks-cluster-vpc-route-table",children:"Update the EKS cluster VPC's route table"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#update-rds-vpc-route-table",children:"Update the RDS VPC's route table"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#update-rds-instance-security-group",children:"Update the RDS instance's security group"})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#test-the-connection",children:"Test the connection"})}),"\n"]}),"\n",(0,a.jsxs)(e.h2,{children:["1. Premise ",(0,a.jsx)("a",{id:"premise"})]}),"\n",(0,a.jsx)(e.p,{children:"When moving your services to the Kubernetes ecosystem for the first time, it is best practice to port only the stateless parts to begin with."}),"\n",(0,a.jsxs)(e.p,{children:["Here's the problem I had to solve: Our service uses ",(0,a.jsx)(e.a,{href:"https://aws.amazon.com/rds/mysql/",children:"Amazon RDS for MySQL"}),". Both the RDS instance(s) and EKS reside within their own dedicated ",(0,a.jsx)(e.a,{href:"https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html",children:"VPC"}),". How do resources running within AWS EKS communicate with the database?"]}),"\n",(0,a.jsx)(c.Z,{src:"/0/1_9f54sopkrm2za71fhvl5.png",alt:"Problem visualised"}),"\n",(0,a.jsx)(e.p,{children:"Let's dive right in!"}),"\n",(0,a.jsxs)(e.h2,{children:["2. Setup the MySQL Database (Amazon RDS) ",(0,a.jsx)("a",{id:"setup-the-mysql-database"})]}),"\n",(0,a.jsx)(e.p,{children:"We will be using the AWS CLI for setting up MySQL database."}),"\n",(0,a.jsxs)(e.h3,{children:["2.1 Create the VPC ",(0,a.jsx)("a",{id:"rds-create-the-vpc"})]}),"\n",(0,a.jsxs)(e.p,{children:["We will first create a VPC with the CIDR block ",(0,a.jsx)(e.code,{children:"10.0.0.0/24"})," which accommodate 254 hosts in all. This is ",(0,a.jsx)(e.strong,{children:"more than enough"})," to host our RDS instance."]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ aws ec2 create-vpc --cidr-block 10.0.0.0/24 | jq ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'{VpcId:.Vpc.VpcId,CidrBlock:.Vpc.CidrBlock}'"}),"\n{\n    ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"VpcId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"vpc-0cf40a5f6db5eb3cd"'}),",\n    ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"CidrBlock"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"10.0.0.0/24"'}),"\n}\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Export the RDS VPC ID for easy reference in the subsequent commands"}),"\n$ ",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"export"})," RDS_VPC_ID=vpc-0cf40a5f6db5eb3cd\n"]})}),"\n",(0,a.jsxs)(e.h3,{children:["2.2 Create the subnets ",(0,a.jsx)("a",{id:"rds-create-subnets"})]}),"\n",(0,a.jsxs)(e.p,{children:["RDS instances launched in a VPC must have a ",(0,a.jsx)(e.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_VPC.WorkingWithRDSInstanceinaVPC.html#USER_VPC.Subnets",children:"DB subnet group"}),". DB subnet groups are a collection of subnets within a VPC. Each DB subnet group should have ",(0,a.jsx)(e.code,{children:"subnets"})," in at least two ",(0,a.jsx)(e.code,{children:"Availability Zones"})," in a given ",(0,a.jsx)(e.code,{children:"AWS Region"}),"."]}),"\n",(0,a.jsxs)(e.p,{children:["We will divide the RDS VPC (",(0,a.jsx)(e.code,{children:"RDS_VPC_ID"}),") into two equal subnets: ",(0,a.jsx)(e.code,{children:"10.0.0.0/25"})," and ",(0,a.jsx)(e.code,{children:"10.0.0.128/25"}),"."]}),"\n",(0,a.jsxs)(e.p,{children:["So, let's create the first subnet in the availability zone ",(0,a.jsx)(e.code,{children:"ap-south-1b"}),":"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ aws ec2 create-subnet --availability-zone ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ap-south-1b"'})," --vpc-id ",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${RDS_VPC_ID}"})," --cidr-block 10.0.0.0/25 | jq ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'{SubnetId:.Subnet.SubnetId,AvailabilityZone:.Subnet.AvailabilityZone,CidrBlock:.Subnet.CidrBlock,VpcId:.Subnet.VpcId}'"}),"\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Response:"}),"\n{\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"SubnetId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"subnet-042a4bee8e92287e8"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"AvailabilityZone"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ap-south-1b"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"CidrBlock"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"10.0.0.0/25"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"VpcId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"vpc-0cf40a5f6db5eb3cd"'}),"\n}\n\n"]})}),"\n",(0,a.jsxs)(e.p,{children:["and the second one in the availability zone ",(0,a.jsx)(e.code,{children:"ap-south-1a"})]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ aws ec2 create-subnet --availability-zone ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ap-south-1a"'})," --vpc-id ",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${RDS_VPC_ID}"})," --cidr-block 10.0.0.128/25 | jq ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'{SubnetId:.Subnet.SubnetId,AvailabilityZone:.Subnet.AvailabilityZone,CidrBlock:.Subnet.CidrBlock,VpcId:.Subnet.VpcId}'"}),"\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Response:"}),"\n{\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"SubnetId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"subnet-0c01a5ba480b930f4"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"AvailabilityZone"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ap-south-1a"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"CidrBlock"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"10.0.0.128/25"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"VpcId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"vpc-0cf40a5f6db5eb3cd"'}),"\n}\n"]})}),"\n",(0,a.jsx)(e.p,{children:"Each VPC has an implicit router which controls where network traffic is directed. Each subnet in a VPC must be explicitly associated with a route table, which controls the routing for the subnet."}),"\n",(0,a.jsx)(e.p,{children:"Let's go ahead and associate these two subnet that we created, to the VPC's route table:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:[(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Fetch the route table information"}),"\n$ aws ec2 describe-route-tables --filters Name=vpc-id,Values=",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${RDS_VPC_ID}"})," | jq ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'.RouteTables[0].RouteTableId'"}),"\n",(0,a.jsx)(e.span,{className:"hljs-string",children:'"rtb-0e680357de97595b1"'}),"\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# For easy reference"}),"\n$ ",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"export"})," RDS_ROUTE_TABLE_ID=rtb-0e680357de97595b1\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Associate the first subnet with the route table"}),"\n$ aws ec2 associate-route-table --route-table-id rtb-0e680357de97595b1 --subnet-id subnet-042a4bee8e92287e8\n{\n    ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"AssociationId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"rtbassoc-02198db22b2d36c97"'}),"\n}\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Associate the second subnet with the route table"}),"\n$ aws ec2 associate-route-table --route-table-id rtb-0e680357de97595b1 --subnet-id subnet-0c01a5ba480b930f4\n{\n    ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"AssociationId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"rtbassoc-0e5c3959d360c92ab"'}),"\n}\n\n"]})}),"\n",(0,a.jsxs)(e.h3,{children:["2.3 Create DB Subnet Group ",(0,a.jsx)("a",{id:"rds-create-db-subnet-group"})]}),"\n",(0,a.jsxs)(e.p,{children:["Now that we have two subnets spanning two availability zones, we can go ahead and create the ",(0,a.jsx)(e.strong,{children:"DB subnet group"}),"."]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ aws rds create-db-subnet-group --db-subnet-group-name  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"DemoDBSubnetGroup"'})," --db-subnet-group-description ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"Demo DB Subnet Group"'})," --subnet-ids ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"subnet-042a4bee8e92287e8"'})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"subnet-0c01a5ba480b930f4"'})," | jq ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'{DBSubnetGroupName:.DBSubnetGroup.DBSubnetGroupName,VpcId:.DBSubnetGroup.VpcId,Subnets:.DBSubnetGroup.Subnets[].SubnetIdentifier}'"}),"\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Response:"}),"\n{\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"DBSubnetGroupName"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"demodbsubnetgroup"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"VpcId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"vpc-0cf40a5f6db5eb3cd"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"Subnets"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"subnet-0c01a5ba480b930f4"'}),"\n}\n{\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"DBSubnetGroupName"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"demodbsubnetgroup"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"VpcId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"vpc-0cf40a5f6db5eb3cd"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"Subnets"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"subnet-042a4bee8e92287e8"'}),"\n}\n"]})}),"\n",(0,a.jsxs)(e.h3,{children:["2.4 Create a VPC Security Group ",(0,a.jsx)("a",{id:"rds-create-vpc-security-group"})]}),"\n",(0,a.jsxs)(e.p,{children:["The ",(0,a.jsx)(e.em,{children:"penultimate"})," step to creating the DB instance is creating a VPC security group, an instance level virtual firewall with ",(0,a.jsx)(e.em,{children:"rules"})," to control inbound and outbound traffic."]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-ruby",children:[(0,a.jsx)(e.span,{className:"hljs-variable",children:"$ "}),"aws ec2 create-security-group --group-name ",(0,a.jsx)(e.span,{className:"hljs-title class_",children:"DemoRDSSecurityGroup"})," --description ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"Demo RDS security group"'})," --vpc-id ",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${"}),(0,a.jsx)(e.span,{className:"hljs-variable constant_",children:"RDS_VPC_ID"}),"}\n{\n    ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"GroupId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"sg-06800acf8d6279971"'}),"\n}\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Export the RDS VPC Security Group ID for easy reference in the subsequent commands"}),"\n",(0,a.jsx)(e.span,{className:"hljs-variable",children:"$ "}),"export ",(0,a.jsx)(e.span,{className:"hljs-variable constant_",children:"RDS_VPC_SECURITY_GROUP_ID"}),"=sg-06800acf8d6279971\n"]})}),"\n",(0,a.jsxs)(e.p,{children:["We will use this security group at a later point, to set an ",(0,a.jsx)(e.code,{children:"inbound"})," rule to allow all traffic from the EKS cluster to the RDS instance."]}),"\n",(0,a.jsxs)(e.h3,{children:["2.5 Create a DB Instance in the VPC ",(0,a.jsx)("a",{id:"rds-create-db-instance-in-the-vpc"})]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ aws rds create-db-instance \\\n  --db-name demordsmyqldb \\\n  --db-instance-identifier demordsmyqldbinstance \\\n  --allocated-storage 10 \\\n  --db-instance-class db.t2.micro \\\n  --engine mysql \\\n  --engine-version ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"5.7.26"'})," \\\n  --master-username demoappuser \\\n  --master-user-password demoappuserpassword \\\n  --no-publicly-accessible \\\n  --vpc-security-group-ids ",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${RDS_VPC_SECURITY_GROUP_ID}"})," \\\n  --db-subnet-group-name ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"demodbsubnetgroup"'})," \\\n  --availability-zone ap-south-1b \\\n  --port 3306 | jq ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'{DBInstanceIdentifier:.DBInstance.DBInstanceIdentifier,Engine:.DBInstance.Engine,DBName:.DBInstance.DBName,VpcSecurityGroups:.DBInstance.VpcSecurityGroups,EngineVersion:.DBInstance.EngineVersion,PubliclyAccessible:.DBInstance.PubliclyAccessible}'"}),"\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Respone:"}),"\n{\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"DBInstanceIdentifier"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"demordsmyqldbinstance"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"Engine"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"mysql"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"DBName"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"demordsmyqldb"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"VpcSecurityGroups"'}),": [\n    {\n      ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"VpcSecurityGroupId"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"sg-06800acf8d6279971"'}),",\n      ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"Status"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"active"'}),"\n    }\n  ],\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"EngineVersion"'}),": ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"5.7.26"'}),",\n  ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"PubliclyAccessible"'}),": ",(0,a.jsx)(e.span,{className:"hljs-literal",children:"false"}),"\n}\n"]})}),"\n",(0,a.jsx)(e.p,{children:"We can verify that the DB instance has been created in the UI as well:"}),"\n",(0,a.jsx)(c.Z,{src:"/0/2_5reunqhdinqcp3vlrbq4.png",alt:"RDS MySQL DB Instance Details"}),"\n",(0,a.jsxs)(e.h3,{children:["2.6 Amazon RDS setup diagram ",(0,a.jsx)("a",{id:"rds-setup-diagram"})]}),"\n",(0,a.jsx)(c.Z,{src:"/0/3_feg2ujod4ja6vtudique.jpeg",alt:"AWS RDS Setup Diagram"}),"\n",(0,a.jsxs)(e.h2,{children:["3. Setup the EKS cluster ",(0,a.jsx)("a",{id:"setup-the-eks-cluster"})]}),"\n",(0,a.jsx)(e.p,{children:"Spinning up an EKS cluster on AWS is as simple as:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ eksctl create cluster --name=demo-eks-cluster --nodes=2 --region=ap-south-1\n[\u2139]  using region ap-south-1\n[\u2139]  setting availability zones to [ap-south-1a ap-south-1c ap-south-1b]\n[\u2139]  subnets ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"for"})," ap-south-1a - public:192.168.0.0/19 private:192.168.96.0/19\n[\u2139]  subnets ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"for"})," ap-south-1c - public:192.168.32.0/19 private:192.168.128.0/19\n[\u2139]  subnets ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"for"})," ap-south-1b - public:192.168.64.0/19 private:192.168.160.0/19\n[\u2139]  nodegroup ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ng-ae09882f"'})," will use ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ami-09c3eb35bb3be46a4"'})," [AmazonLinux2/1.12]\n[\u2139]  creating EKS cluster ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"demo-eks-cluster"'})," ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"in"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ap-south-1"'})," region\n[\u2139]  will create 2 separate CloudFormation stacks ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"for"})," cluster itself and the initial nodegroup\n[\u2139]  ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"if"})," you encounter any issues, check CloudFormation console or try ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'eksctl utils describe-stacks --region=ap-south-1 --name=demo-eks-cluster'"}),"\n[\u2139]  2 sequential tasks: { create cluster control plane ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"demo-eks-cluster"'}),", create nodegroup ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ng-ae09882f"'})," }\n[\u2139]  building cluster stack ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"eksctl-demo-eks-cluster-cluster"'}),"\n[\u2139]  deploying stack ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"eksctl-demo-eks-cluster-cluster"'}),"\n[\u2139]  building nodegroup stack ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"eksctl-demo-eks-cluster-nodegroup-ng-ae09882f"'}),"\n[\u2139]  --nodes-min=2 was ",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"set"})," automatically ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"for"})," nodegroup ng-ae09882f\n[\u2139]  --nodes-max=2 was ",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"set"})," automatically ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"for"})," nodegroup ng-ae09882f\n[\u2139]  deploying stack ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"eksctl-demo-eks-cluster-nodegroup-ng-ae09882f"'}),"\n[\u2714]  all EKS cluster resource ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"for"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"demo-eks-cluster"'})," had been created\n[\u2714]  saved kubeconfig as ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"/Users/Bensooraj/.kube/config"'}),"\n[\u2139]  adding role ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"arn:aws:iam::account_number:role/eksctl-demo-eks-cluster-nodegroup-NodeInstanceRole-1631FNZJZTDSK"'})," to auth ConfigMap\n[\u2139]  nodegroup ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ng-ae09882f"'})," has 0 node(s)\n[\u2139]  waiting ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"for"})," at least 2 node(s) to become ready ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"in"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ng-ae09882f"'}),"\n[\u2139]  nodegroup ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ng-ae09882f"'})," has 2 node(s)\n[\u2139]  node ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ip-192-168-30-190.ap-south-1.compute.internal"'})," is ready\n[\u2139]  node ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ip-192-168-92-207.ap-south-1.compute.internal"'})," is ready\n[\u2139]  kubectl ",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"command"})," should work with ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"/Users/Bensooraj/.kube/config"'}),", try ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'kubectl get nodes'"}),"\n[\u2714]  EKS cluster ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"demo-eks-cluster"'})," ",(0,a.jsx)(e.span,{className:"hljs-keyword",children:"in"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"ap-south-1"'})," region is ready\n\n"]})}),"\n",(0,a.jsxs)(e.p,{children:["We will create a kubernetes ",(0,a.jsx)(e.code,{children:"Service"})," named ",(0,a.jsx)(e.code,{children:"mysql-service"})," of type ",(0,a.jsx)(e.code,{children:"ExternalName"})," aliasing the RDS endpoint ",(0,a.jsx)(e.code,{children:"demordsmyqldbinstance.cimllxgykuy3.ap-south-1.rds.amazonaws.com"}),"."]}),"\n",(0,a.jsxs)(e.p,{children:["Run ",(0,a.jsx)(e.code,{children:"kubectl apply -f mysql-service.yaml"})," to create the service."]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-yaml",children:[(0,a.jsx)(e.span,{className:"hljs-comment",children:"# mysql-service.yaml"}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"apiVersion:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"v1"}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"kind:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"Service"}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"metadata:"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"labels:"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"app:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"mysql-service"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"name:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"mysql-service"}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"spec:"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"externalName:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"demordsmyqldbinstance.cimllxgykuy3.ap-south-1.rds.amazonaws.com"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"selector:"}),"\n    ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"app:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"mysql-service"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"type:"})," ",(0,a.jsx)(e.span,{className:"hljs-string",children:"ExternalName"}),"\n",(0,a.jsx)(e.span,{className:"hljs-attr",children:"status:"}),"\n  ",(0,a.jsx)(e.span,{className:"hljs-attr",children:"loadBalancer:"})," {}\n"]})}),"\n",(0,a.jsxs)(e.p,{children:["Now, clients running inside the pods within the cluster can connect to the RDS instance using ",(0,a.jsx)(e.code,{children:"mysql-service"}),"."]}),"\n",(0,a.jsxs)(e.p,{children:["Let's test the connect using a throwaway ",(0,a.jsx)(e.code,{children:"busybox"})," pod:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ kubectl run -i --",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"tty"})," --",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"rm"})," debug --image=busybox --restart=Never -- sh\nIf you don",(0,a.jsx)(e.span,{className:"hljs-string",children:"'t see a command prompt, try pressing enter.\n/ # nc mysql-service 3306\n^Cpunt!\n\n"})]})}),"\n",(0,a.jsx)(e.p,{children:"It is evident that the pod is unable to get through! Let's solve the problem now."}),"\n",(0,a.jsxs)(e.h2,{children:["4. Let's build the bridge! ",(0,a.jsx)("a",{id:"lets-build-the-bridge"})]}),"\n",(0,a.jsxs)(e.p,{children:["We are going to create a ",(0,a.jsx)(e.a,{href:"https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html",children:"VPC Peering Connection"})," to facilitate communication between the resources in the two VPCs. According to the documentation:"]}),"\n",(0,a.jsxs)(e.blockquote,{children:["\n",(0,a.jsxs)(e.p,{children:["A ",(0,a.jsx)(e.strong,{children:"VPC peering connection"})," is a networking connection between two VPCs that enables you to route traffic between them using private IPv4 addresses or IPv6 addresses. Instances in either VPC can communicate with each other as if they are within the same network. You can create a VPC peering connection between your own VPCs, or with a VPC in another AWS account. The VPCs can be in different regions (also known as an inter-region VPC peering connection)."]}),"\n"]}),"\n",(0,a.jsxs)(e.h3,{children:["4.1 Create and Accept a VPC Peering Connection ",(0,a.jsx)("a",{id:"create-and-accept-vpc-peering-connections"})]}),"\n",(0,a.jsx)(e.p,{children:"To create a VPC peering connection, navigate to:"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsx)(e.p,{children:"VPC console: https://console.aws.amazon.com/vpc/"}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsxs)(e.p,{children:["Select ",(0,a.jsx)(e.code,{children:"Peering Connections"})," and click on ",(0,a.jsx)(e.code,{children:"Create Peering Connection"}),"."]}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsxs)(e.p,{children:["Configure the details as follows (select the EKS VPC as the ",(0,a.jsx)(e.code,{children:"Requester"})," and the RDS VPC as the ",(0,a.jsx)(e.code,{children:"Accepter"}),"):"]}),"\n",(0,a.jsx)(c.Z,{src:"/0/4_5a2ilp9pzgiih073mlvp.png",alt:"Configuration"}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsxs)(e.p,{children:["Click on ",(0,a.jsx)(e.code,{children:"Create Peering Connection"})]}),"\n",(0,a.jsx)(c.Z,{src:"/0/5_9yw3pc84bwo31nihvcvg.jpg",alt:"Confirmation page"}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsxs)(e.p,{children:["Select the ",(0,a.jsx)(e.code,{children:"Peering Connection"})," that we just created. Click on ",(0,a.jsx)(e.code,{children:"Actions"})," => ",(0,a.jsx)(e.code,{children:"Accept"}),". Again, in the confirmation dialog box, click on ",(0,a.jsx)(e.code,{children:"Yes, Accept"}),"."]}),"\n",(0,a.jsx)(c.Z,{src:"/0/6_i3pgejmth4xmhb88fybn.jpg",alt:"Yes, Accept"}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"Don't forget to export the VPC Peering Connection ID:"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-bash",children:["$ ",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"export"})," VPC_PEERING_CONNECTION_ID=pcx-0cc408e65493fe197\n"]})}),"\n",(0,a.jsxs)(e.h3,{children:["4.2 Update the EKS cluster VPC's route table ",(0,a.jsx)("a",{id:"update-eks-cluster-vpc-route-table"})]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:[(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Fetch the route table associated with the 3 public subnets of the VPC created by `eksctl`:"}),"\n$ aws ec2 describe-route-tables --filters Name=",(0,a.jsx)(e.span,{className:"hljs-string",children:'"tag:aws:cloudformation:logical-id"'}),",Values=",(0,a.jsx)(e.span,{className:"hljs-string",children:'"PublicRouteTable"'})," | jq ",(0,a.jsx)(e.span,{className:"hljs-string",children:"'.RouteTables[0].RouteTableId'"}),"\n",(0,a.jsx)(e.span,{className:"hljs-string",children:'"rtb-06103bd0704b3a9ee"'}),"\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# For easy reference"}),"\n",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"export"})," EKS_ROUTE_TABLE_ID=rtb-06103bd0704b3a9ee\n\n",(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Add route: All traffic to (destination) the RDS VPC CIDR block is via the VPC Peering Connection (target)"}),"\n$ aws ec2 create-route --route-table-id ",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${EKS_ROUTE_TABLE_ID}"})," --destination-cidr-block 10.0.0.0/24 --vpc-peering-connection-id ",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${VPC_PEERING_CONNECTION_ID}"}),"\n{\n    ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"Return"'}),": ",(0,a.jsx)(e.span,{className:"hljs-literal",children:"true"}),"\n}\n"]})}),"\n",(0,a.jsxs)(e.h3,{children:["4.3 Update the RDS VPC's route table ",(0,a.jsx)("a",{id:"update-rds-vpc-route-table"})]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:[(0,a.jsx)(e.span,{className:"hljs-comment",children:"# Add route: All traffic to (destination) the EKS cluster CIDR block is via the VPC Peering Connection (target)"}),"\n$ aws ec2 create-route --route-table-id ",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${RDS_ROUTE_TABLE_ID}"})," --destination-cidr-block 192.168.0.0/16 --vpc-peering-connection-id ",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${VPC_PEERING_CONNECTION_ID}"}),"\n{\n    ",(0,a.jsx)(e.span,{className:"hljs-string",children:'"Return"'}),": ",(0,a.jsx)(e.span,{className:"hljs-literal",children:"true"}),"\n}\n"]})}),"\n",(0,a.jsxs)(e.h3,{children:["4.4 Update the RDS instance's security group ",(0,a.jsx)("a",{id:"update-rds-instance-security-group"})]}),"\n",(0,a.jsxs)(e.p,{children:["Allow all ingress traffic from the EKS cluster to the RDS instance on port ",(0,a.jsx)(e.code,{children:"3306"}),":"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ aws ec2 authorize-security-group-ingress --group-id ",(0,a.jsx)(e.span,{className:"hljs-variable",children:"${RDS_VPC_SECURITY_GROUP_ID}"})," --protocol tcp --port 3306 --cidr 192.168.0.0/16\n"]})}),"\n",(0,a.jsxs)(e.h2,{children:["5. Test the connection ",(0,a.jsx)("a",{id:"test-the-connection"})]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsxs)(e.code,{className:"hljs language-sh",children:["$ kubectl run -i --",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"tty"})," --",(0,a.jsx)(e.span,{className:"hljs-built_in",children:"rm"})," debug --image=busybox --restart=Never -- sh\nIf you don",(0,a.jsx)(e.span,{className:"hljs-string",children:"'t see a command prompt, try pressing enter.\n/ # nc mysql-service 3306\nN\n5.7.26-logR&=lk`xTH???mj\t_5#K)>mysql_native_password\n"})]})}),"\n",(0,a.jsxs)(e.p,{children:["We can see that ",(0,a.jsx)(e.code,{children:"busybox"})," can now successfully talk to the RDS instance using the service ",(0,a.jsx)(e.code,{children:"mysql-service"}),"."]}),"\n",(0,a.jsx)(e.p,{children:"That said, this is what our final setup looks like:"}),"\n",(0,a.jsx)(c.Z,{src:"/0/7_1ba38e5zu8i36egibtvc.jpeg",alt:"Final setup"}),"\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.strong,{children:"Note"}),":\nThis setup allows all pods in the EKS cluster to access the RDS instance. Depending on your use case, this may or may not be ideal to your architecture. To implement more fine-grained access control, considering setting up a ",(0,a.jsx)(e.a,{href:"https://kubernetes.io/docs/concepts/services-networking/network-policies/",children:(0,a.jsx)(e.code,{children:"NetworkPolicy"})})," resource."]}),"\n",(0,a.jsx)(e.p,{children:"Useful resources:"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"http://www.davidc.net/sites/default/subnets/subnets.html",children:"Visual Subnet Calculator"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://github.com/stedolan/jq",children:"jq - Command-line JSON processor"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://docs.aws.amazon.com/cli/latest/index.html",children:"AWS CLI Command Reference"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://docs.aws.amazon.com/vpc/latest/peering/what-is-vpc-peering.html",children:"AWS VPC Peering"})}),"\n"]})]})}e.default=function(s){var e=void 0===s?{}:s,n=Object.assign({},(0,l.ah)(),e.components).wrapper;return n?(0,a.jsx)(n,Object.assign({},e,{children:(0,a.jsx)(r,e)})):r(e)}},5711:function(s){s.exports={carousel:"MDImage_carousel__N8hEe"}}},function(s){s.O(0,[774,888,179],(function(){return e=9630,s(s.s=e);var e}));var e=s.O();_N_E=e}]);